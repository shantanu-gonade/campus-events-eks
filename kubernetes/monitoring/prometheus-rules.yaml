---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: campus-events-alerts
  namespace: monitoring
  labels:
    app: kube-prometheus-stack
    release: kube-prom-stack
spec:
  groups:
  - name: campus-events-application
    interval: 30s
    rules:
    
    # High Error Rate Alert
    - alert: HighErrorRate
      expr: |
        (
          sum(rate(http_requests_total{namespace="campus-events",status_code=~"5.."}[5m])) by (app)
          /
          sum(rate(http_requests_total{namespace="campus-events"}[5m])) by (app)
        ) > 0.05
      for: 5m
      labels:
        severity: critical
        namespace: campus-events
      annotations:
        summary: "High error rate in {{ $labels.app }}"
        description: "Error rate is {{ $value | humanizePercentage }} for {{ $labels.app }}"
    
    # High Response Time Alert
    - alert: HighResponseTime
      expr: |
        histogram_quantile(0.95, 
          sum(rate(http_request_duration_seconds_bucket{namespace="campus-events"}[5m])) by (le, app)
        ) > 2
      for: 5m
      labels:
        severity: warning
        namespace: campus-events
      annotations:
        summary: "High response time in {{ $labels.app }}"
        description: "95th percentile response time is {{ $value }}s for {{ $labels.app }}"
    
    # Pod Down Alert (excluding test pods and completed jobs)
    - alert: PodDown
      expr: |
        kube_pod_status_phase{namespace="campus-events", phase!="Running", phase!="Succeeded", pod!~"test-.*"} > 0
      for: 5m
      labels:
        severity: critical
        namespace: campus-events
      annotations:
        summary: "Pod {{ $labels.pod }} is down"
        description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} is in {{ $labels.phase }} phase"
    
    # Low Replica Count Alert
    - alert: LowReplicaCount
      expr: |
        kube_deployment_status_replicas_available{namespace="campus-events"} < 2
      for: 5m
      labels:
        severity: warning
        namespace: campus-events
      annotations:
        summary: "Low replica count for {{ $labels.deployment }}"
        description: "Deployment {{ $labels.deployment }} has only {{ $value }} replicas available"
    
    # High CPU Usage Alert
    - alert: HighCPUUsage
      expr: |
        sum(rate(container_cpu_usage_seconds_total{namespace="campus-events",container!=""}[5m])) by (pod) > 0.8
      for: 5m
      labels:
        severity: warning
        namespace: campus-events
      annotations:
        summary: "High CPU usage in pod {{ $labels.pod }}"
        description: "CPU usage is {{ $value | humanize }} for pod {{ $labels.pod }}"
    
    # High Memory Usage Alert
    - alert: HighMemoryUsage
      expr: |
        (
          sum(container_memory_working_set_bytes{namespace="campus-events",container!=""}) by (pod)
          /
          sum(container_spec_memory_limit_bytes{namespace="campus-events",container!=""}) by (pod)
        ) > 0.8
      for: 5m
      labels:
        severity: warning
        namespace: campus-events
      annotations:
        summary: "High memory usage in pod {{ $labels.pod }}"
        description: "Memory usage is {{ $value | humanizePercentage }} of limit for pod {{ $labels.pod }}"
    
    # Database Connection Issues
    - alert: DatabaseConnectionIssues
      expr: |
        sum(rate(database_connection_errors_total{namespace="campus-events"}[5m])) by (app) > 0.1
      for: 5m
      labels:
        severity: critical
        namespace: campus-events
      annotations:
        summary: "Database connection issues in {{ $labels.app }}"
        description: "{{ $labels.app }} is experiencing {{ $value }} database connection errors per second"
    
    # HPA at Maximum Replicas
    - alert: HPAMaxedOut
      expr: |
        kube_horizontalpodautoscaler_status_current_replicas{namespace="campus-events"} 
        >= 
        kube_horizontalpodautoscaler_spec_max_replicas{namespace="campus-events"}
      for: 10m
      labels:
        severity: warning
        namespace: campus-events
      annotations:
        summary: "HPA {{ $labels.horizontalpodautoscaler }} has reached maximum replicas"
        description: "Consider increasing max replicas for HPA {{ $labels.horizontalpodautoscaler }}"
